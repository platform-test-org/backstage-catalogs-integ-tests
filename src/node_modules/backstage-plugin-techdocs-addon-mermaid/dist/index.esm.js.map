{"version":3,"file":"index.esm.js","sources":["../src/Mermaid/hooks.ts","../src/Mermaid/Mermaid.tsx","../src/plugin.ts"],"sourcesContent":["/*\n * Copyright 2022 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nconst mermaidStart = /^(\\s*)(graph|flowchart|sequenceDiagram|classDiagram|stateDiagram|erDiagram|journey|gantt|pie|requirementDiagram|gitGraph)/;\n\nexport const isMermaidCode = (code: string): boolean => {\n  return code.match(mermaidStart) !== null\n}\n","/*\n * Copyright 2022 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { useEffect } from 'react';\nimport { PaletteType, useTheme } from '@material-ui/core';\n\nimport { useShadowRootElements } from '@backstage/plugin-techdocs-react';\nimport mermaid from 'mermaid'\nimport { isMermaidCode } from './hooks';\nimport { MermaidProps } from './props';\nimport { BackstageTheme } from '@backstage/theme';\nimport { MermaidConfig } from 'mermaid';\n\nexport function selectConfig(backstagePalette: PaletteType, properties: MermaidProps): MermaidConfig {\n  // Theme set directly in the Mermaid configuration takes\n  // precedence for backwards-compatibility\n  if(properties.config) {\n    return properties.config;\n  }\n\n  if(backstagePalette === 'light') {\n    return properties.lightConfig || {};\n  }\n\n  return properties.darkConfig || {};\n}\n\n/**\n * Show report issue button when text is highlighted\n */\n\nlet diagramId = 0\n\nexport const MermaidAddon = (properties: MermaidProps) => {\n  const highlightTables = useShadowRootElements<HTMLDivElement>(['.highlighttable']);\n  const theme = useTheme<BackstageTheme>();\n\n  useEffect(() => {\n    highlightTables.forEach(highlightTable => {\n      if (!highlightTable.classList.contains('language-text')) {\n         return;\n      }\n\n      // Skip already processed\n      if (highlightTable.style.display === 'none') {\n        return\n      }\n\n      const codeBlock = highlightTable.querySelector('code')\n      if (!codeBlock) {\n        return\n      }\n\n      const diagramText = codeBlock.innerText\n\n      // Ideally we could detect mermaid based on some annotation, but use a regex for now\n      if (!isMermaidCode(diagramText)) {\n        return\n      }\n\n      highlightTable.style.display = 'none'\n\n      const diagramElement = document.createElement('div')\n      diagramElement.className = \"mermaid\"\n\n      highlightTable.parentNode?.insertBefore(diagramElement, highlightTable.nextSibling);\n\n      const id = `mermaid-${diagramId++}`\n\n      const config = selectConfig(theme.palette.type, properties);\n      if(config) {\n        mermaid.initialize(config);\n      }\n\n      mermaid.render(id, diagramText, (svgGraph: string) => {\n        diagramElement.innerHTML = svgGraph\n      });\n    });\n  }, [highlightTables, properties, theme.palette.type]);\n\n  return null;\n};\n","/*\n * Copyright 2022 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport { createPlugin } from '@backstage/core-plugin-api';\nimport {\n  createTechDocsAddonExtension,\n  TechDocsAddonLocations,\n} from '@backstage/plugin-techdocs-react';\n\nimport { MermaidAddon } from './Mermaid';\nimport type { MermaidProps } from './Mermaid';\n\n/**\n * The TechDocs addons mermaid plugin\n *\n * @public\n */\n\n\nexport const techdocsAddonMermaidPlugin = createPlugin({\n  id: 'techdocs-addon-mermaid',\n});\n\n/**\n * TechDocs addon that lets you render Mermaid diagrams\n *\n * @public\n */\n\n export const Mermaid = techdocsAddonMermaidPlugin.provide(\n  createTechDocsAddonExtension<MermaidProps>({\n    name: 'MermaidDiagram',\n    location: TechDocsAddonLocations.Content,\n    component: MermaidAddon,\n  }),\n);\n"],"names":[],"mappings":"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"}